<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .patsyntax {color:#808080;background-color:#E0E0E0;}
    .patsyntax span.keyword {color:#000000;font-weight:bold;}
    .patsyntax span.comment {color:#787878;font-style:italic;}
    .patsyntax span.extcode {color:#A52A2A;}
    .patsyntax span.neuexp  {color:#800080;}
    .patsyntax span.staexp  {color:#0000F0;}
    .patsyntax span.prfexp  {color:#603030;}
    .patsyntax span.dynexp  {color:#F00000;}
    .patsyntax span.stalab  {color:#0000F0;font-style:italic}
    .patsyntax span.dynlab  {color:#F00000;font-style:italic}
    .patsyntax span.dynstr  {color:#008000;font-style:normal}
    .patsyntax span.stacstdec  {text-decoration:none;}
    .patsyntax span.stacstuse  {color:#0000CF;text-decoration:underline;}
    .patsyntax span.dyncstdec  {text-decoration:none;}
    .patsyntax span.dyncstuse  {color:#B80000;text-decoration:underline;}
    .patsyntax span.dyncst_implement  {color:#B80000;text-decoration:underline;}
  </style>
</head>
<body class="patsyntax">

<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2014 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom*)</span>
<span class="comment">(* Start time: September, 2014 *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX-2013-04:</span>
<span class="comment">// intrange (l, r) is for integers i satisfying l &lt;= i &lt; r</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="neuexp"><span class="keyword">#define</span>
ATS_PACKNAME "ATSLIB.libats.ML"</span>
<span class="neuexp"><span class="keyword">#define</span>
ATS_EXTERN_PREFIX "atslib_ML_"</span> <span class="comment">// prefix for external names</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_repeat_lazy
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">lazy</span><span class="keyword">(</span><span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_repeat_cloref
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun0</span><span class="keyword">(</span><span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_repeat_method
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun0</span><span class="keyword">(</span><span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> repeat <span class="keyword">with</span> int_repeat_lazy</span>
<span class="dynexp"><span class="keyword">overload</span> repeat <span class="keyword">with</span> int_repeat_cloref</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>repeat <span class="keyword">with</span> int_repeat_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_forall_cloref
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">bool</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_forall_method
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span> <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">bool</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>forall <span class="keyword">with</span> int_forall_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_foreach_cloref
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_foreach_method
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span> <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>foreach <span class="keyword">with</span> int_foreach_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>res<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
int_foldleft_cloref
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ini<span class="keyword">:</span> <span class="staexp">res</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span> <span class="keyword">(</span><span class="staexp">res</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">res</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">res</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>res<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
int_foldleft_method
  <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">TYPE</span><span class="keyword">(</span><span class="staexp">res</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">(</span>ini<span class="keyword">:</span> <span class="staexp">res</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span> <span class="keyword">(</span><span class="staexp">res</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">res</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">res</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>foldleft <span class="keyword">with</span> int_foldleft_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
intrange_forall_cloref
  <span class="keyword">(</span>l<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">bool</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
intrange_forall_method
  <span class="keyword">(</span>lr<span class="keyword">:</span> <span class="keyword">@(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">bool</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>forall <span class="keyword">with</span> intrange_forall_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
intrange_foreach_cloref
  <span class="keyword">(</span>l<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
intrange_foreach_method
  <span class="keyword">(</span>lr<span class="keyword">:</span> <span class="keyword">@(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun1</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>foreach <span class="keyword">with</span> intrange_foreach_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>res<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
intrange_foldleft_cloref
  <span class="keyword">(</span>l<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ini<span class="keyword">:</span> <span class="staexp">res</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span> <span class="keyword">(</span><span class="staexp">res</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">res</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">res</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>res<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
intrange_foldleft_method
  <span class="keyword">(</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">TYPE</span><span class="keyword">(</span><span class="staexp">res</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">(</span>ini<span class="keyword">:</span> <span class="staexp">res</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span> <span class="keyword">(</span><span class="staexp">res</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">res</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">res</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>foldleft <span class="keyword">with</span> intrange_foldleft_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_streamGte<span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>streamGte <span class="keyword">with</span> int_streamGte</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int_streamGte_vt<span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream_vt</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>streamGte_vt <span class="keyword">with</span> int_streamGte_vt</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
int_list0_map_cloref
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> fopr<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
int_list0_map_method
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">TYPE</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>list0_map <span class="keyword">with</span> int_list0_map_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
int_array0_map_cloref
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> fopr<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">array0</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
int_array0_map_method
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">TYPE</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">array0</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>array0_map <span class="keyword">with</span> int_array0_map_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
int_stream_map_cloref
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> fopr<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
int_stream_map_method
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">TYPE</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>stream_map <span class="keyword">with</span> int_stream_map_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
int_stream_vt_map_cloref
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> fopr<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
int_stream_vt_map_method
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">TYPE</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">cfun</span><span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> <span class="keyword">.</span>stream_vt_map <span class="keyword">with</span> int_stream_vt_map_method</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
int2_foreach_cloref
  <span class="keyword">(</span>n1<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> n2<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
intrange2_foreach_cloref
  <span class="keyword">(</span>l1<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r1<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> l2<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r2<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [intrange.sats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: August, 2013 *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">#define</span>
ATS_PACKNAME "ATSLIB.libats.ML"</span>
<span class="neuexp"><span class="keyword">#define</span>
ATS_EXTERN_PREFIX "atslib_ML_"</span> <span class="comment">// prefix for external names</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX: for maps of elements of type (a)</span>
<span class="comment">//</span>
<span class="staexp"><span class="keyword">abstype</span>
map_type
<span class="keyword">(</span>
  key<span class="keyword">:</span><span class="keyword">t@ype</span>
<span class="keyword">,</span> itm<span class="keyword">:</span><span class="keyword">t0ype+</span>
<span class="keyword">)</span> <span class="keyword">=</span> ptr</span><span class="comment">(*boxed*)</span>
<span class="comment">//</span>
<span class="keyword">typedef</span>
<span class="staexp">map<span class="keyword">(</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">,</span> <span class="staexp">itm<span class="keyword">:</span>t0p</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="staexp">map_type</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
compare_key_key<span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">int</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
funmap_nil<span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
funmap_make_nil<span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
funmap_is_nil
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
funmap_isnot_nil
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_size<span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">size_t</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_search
  <span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">// end of [funmap_search]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_insert
<span class="keyword">(</span>
  <span class="staexp">&amp;</span><span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> <span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span> <span class="comment">// end of [funmap_insert]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_takeout
<span class="keyword">(</span>
  map<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span> <span class="comment">// end of [funmap_takeout]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_remove
  <span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span><span class="keyword">t@ype</span>
<span class="keyword">}</span></span> fprint_funmap
<span class="keyword">(</span>
  out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// end of [fprint_funmap]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
fprint_funmap$sep<span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// fprint("; ")</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
fprint_funmap$mapto<span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// fprint("-&gt;")</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_funmap</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_foreach
  <span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p
<span class="keyword">;</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
funmap_foreach_env
  <span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p
<span class="keyword">;</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
funmap_foreach$fwork
  <span class="keyword">(</span>key<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> itm<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">itm</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_foreach_cloref
<span class="keyword">(</span>
  map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span>
<span class="keyword">,</span> fwork<span class="keyword">:</span> <span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// end-of-function</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_listize
  <span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0</span> <span class="keyword">@(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> funmap_streamize
  <span class="keyword">(</span>map<span class="keyword">:</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stream_vt</span> <span class="keyword">@(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span>
<span class="staexp">map_modtype
<span class="keyword">(</span>
  <span class="staexp">key<span class="keyword">:</span> t0p</span><span class="keyword">,</span> <span class="staexp">itm<span class="keyword">:</span> t0p</span>
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$rec</span><span class="keyword">{</span>
<span class="comment">//</span>
<span class="stalab">nil</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> <span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">)</span>
<span class="keyword">,</span>
<span class="stalab">size</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_size&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">is_nil</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> <span class="staexp">bool</span>
<span class="keyword">,</span>
<span class="stalab">isnot_nil</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="staexp">map</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> <span class="staexp">bool</span>
<span class="keyword">,</span>
<span class="stalab">search</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_search&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">insert</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_insert&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">remove</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_remove&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">takeout</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_takeout&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">listize</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_listize&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">streamiize</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funmap_streamize&lt;key<span class="keyword">,</span>itm<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [set_modtype] *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p
<span class="keyword">;</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funmap_make_module<span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">map_modtype</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [funmap.sats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: August, 2013 *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">#define</span> ATS_PACKNAME "ATSLIB.libats.ML"</span>
<span class="neuexp"><span class="keyword">#define</span> ATS_EXTERN_PREFIX "atslib_ML_"</span> <span class="comment">// prefix for external names</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX-2013-08:</span>
<span class="comment">// for sets of elements of type a</span>
<span class="comment">//</span>
<span class="staexp"><span class="keyword">abstype</span>
set_type
<span class="keyword">(</span>
  a<span class="keyword">:</span><span class="keyword">t@ype+</span>
<span class="keyword">)</span> <span class="keyword">=</span> ptr</span><span class="comment">(*boxed*)</span>
<span class="comment">//</span>
<span class="keyword">typedef</span> <span class="staexp">set<span class="keyword">(</span><span class="staexp">a<span class="keyword">:</span>t0p</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="staexp">set_type</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
compare_elt_elt<span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">int</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span> funset_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span> funset_make_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span> funset_sing<span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span> funset_make_sing<span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_make_list<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list0</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
fprint_funset
<span class="keyword">(</span>
  out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> set<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// end of [fprint_funset]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
fprint_funset$sep<span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// fprint(", ")</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_funset</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
funset_is_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
funset_isnot_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_size<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">size_t</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_is_member<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_isnot_member<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_insert
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span><span class="comment">(*[x0] in [xs]*)</span>
<span class="comment">// end of [funset_insert]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_remove
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span><span class="comment">(*[x0] in [xs]*)</span>
<span class="comment">// end of [funset_remove]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_getmax_opt<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_getmin_opt<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_takeoutmax_opt<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_takeoutmin_opt<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_union<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_intersect<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_differ<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_symdiff<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_equal<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX: set ordering induced by the ordering on elements</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_compare<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">int</span></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_is_subset<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_is_supset<span class="keyword">(</span>xs1<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_foreach<span class="keyword">(</span>set<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
funset_foreach_env
  <span class="keyword">(</span>set<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">// end of [funset_foreach_env]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
funset_foreach$fwork<span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_foreach_cloref
  <span class="keyword">(</span>set<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> fwork<span class="keyword">:</span> <span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_tabulate_cloref
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">,</span> fopr<span class="keyword">:</span> <span class="keyword">(</span><span class="staexp">natLt</span><span class="keyword">(</span><span class="staexp">n</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_listize<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">list0</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
funset_streamize<span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">stream_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span>
<span class="staexp">set_modtype
<span class="keyword">(</span>
  <span class="staexp">elt<span class="keyword">:</span><span class="keyword">t@ype</span></span>
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$rec</span><span class="keyword">{</span>
<span class="comment">//</span>
<span class="stalab">nil</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> <span class="staexp">set</span><span class="keyword">(</span><span class="staexp">elt</span><span class="keyword">)</span>
<span class="keyword">,</span>
<span class="stalab">sing</span> <span class="keyword">=</span>
<span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_sing&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">make_list</span> <span class="keyword">=</span>
<span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_make_list&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">size</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_size&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">is_nil</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="staexp">set</span><span class="keyword">(</span><span class="staexp">elt</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> <span class="staexp">bool</span>
<span class="keyword">,</span>
<span class="stalab">isnot_nil</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="staexp">set</span><span class="keyword">(</span><span class="staexp">elt</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> <span class="staexp">bool</span>
<span class="keyword">,</span>
<span class="stalab">insert</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_insert&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">remove</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_remove&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">union</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_union&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">intersect</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_intersect&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">listize</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_listize&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="keyword">,</span>
<span class="stalab">streamiize</span> <span class="keyword">=</span> <span class="staexp"><span class="keyword">$d2ctype</span><span class="keyword">(</span>funset_streamize&lt;elt<span class="keyword">&gt;</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [set_modtype] *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span><span class="keyword">t@ype</span><span class="keyword">}</span></span>
funset_make_module<span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">set_modtype</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [funset.sats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: August, 2013 *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">#define</span>
ATS_PACKNAME "ATSLIB.libats.ML"</span>
<span class="neuexp"><span class="keyword">#define</span>
ATS_EXTERN_PREFIX "atslib_ML_"</span> <span class="comment">// prefix for external names</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="keyword">typedef</span>
<span class="staexp">hashtbl <span class="comment">// introduced in [basis.sats]</span>
<span class="keyword">(</span><span class="staexp">key<span class="keyword">:</span><span class="keyword">t@ype</span></span><span class="keyword">,</span> <span class="staexp">itm<span class="keyword">:</span><span class="keyword">t@ype</span></span><span class="keyword">)</span> <span class="keyword">=</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hash_key<span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">ulint</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> equal_key_key<span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">&gt;</span> <span class="staexp">bool</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_make_nil
  <span class="keyword">(</span>cap<span class="keyword">:</span> <span class="staexp">sizeGte</span><span class="keyword">(</span><span class="staexp">1</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
hashtbl_get_size
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">size_t</span></span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
hashtbl_get_capacity
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span><span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">sizeGte</span><span class="keyword">(</span><span class="staexp">1</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_search
  <span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">// end of [hashtbl_search]</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_search_ref
  <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">cPtr0</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">// end of [hashtbl_search_ref]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_insert
  <span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">// end of [hashtbl_insert]</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_insert_any<span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_takeout
  <span class="keyword">(</span>kxs<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">// end of [hashtbl_takeout]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_remove
  <span class="keyword">(</span>kxs<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_takeout_all
  <span class="keyword">(</span>kxs<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0</span> <span class="keyword">@(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">// end of [hashtbl_takeout_all]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span><span class="keyword">t@ype</span>
<span class="keyword">}</span></span> fprint_hashtbl
  <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> tbl<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_hashtbl</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
fprint_hashtbl$sep <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// default: fprint("; ")</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span><span class="keyword">}</span></span>
fprint_hashtbl$mapto <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// default: fprint("-&gt;")</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span><span class="keyword">t@ype</span>
<span class="keyword">}</span></span> fprint_hashtbl_sep_mapto
<span class="keyword">(</span>
  out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> tbl<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> sep<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">,</span> mapto<span class="keyword">:</span> <span class="staexp">string</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// end of [fprint_hashtbl_sep_mapto]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_foreach
  <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p
<span class="keyword">;</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
hashtbl_foreach_env
  <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
<span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p
<span class="keyword">;</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
hashtbl_foreach$fwork
  <span class="keyword">(</span>key<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> itm<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">itm</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_foreach_cloref
<span class="keyword">(</span>
  tbl<span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">,</span> fwork<span class="keyword">:</span> <span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">&amp;</span><span class="staexp">itm</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span><span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span> <span class="comment">// end of [hashtbl_foreach_cloref]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span><span class="staexp"><span class="keyword">{</span>
key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p
<span class="keyword">}</span></span> hashtbl_listize1<span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0</span> <span class="keyword">@(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [hashtblref.sats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: September, 2014 *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/list0.sats"
<span class="keyword">staload</span> "libats/ML/SATS/array0.sats"
<span class="keyword">staload</span> "libats/ML/SATS/intrange.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_repeat_lazy
  <span class="keyword">(</span>n<span class="keyword">,</span> fopr<span class="keyword">)</span> <span class="keyword">=</span>
  int_repeat_cloref&lt;<span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">,</span> lazy2cloref<span class="keyword">(</span>fopr<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_repeat_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> fopr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
loop
<span class="keyword">(</span>
  n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun0</span><span class="keyword">(</span><span class="staexp">void</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">if</span> n <span class="keyword">&gt;</span> <span class="dynexp">0</span>
  <span class="keyword">then</span> <span class="keyword">let</span> <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fopr<span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> loop<span class="keyword">(</span>n-<span class="dynexp">1</span><span class="keyword">,</span> fopr<span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">else</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [loop] *)</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span>n<span class="keyword">,</span> fopr<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [int_repeat_cloref]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_repeat_method
  <span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>fopr<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_repeat_cloref<span class="keyword">(</span>n<span class="keyword">,</span> fopr<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_forall_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span>
  intrange_forall_cloref&lt;<span class="keyword">&gt;</span> <span class="keyword">(</span><span class="dynexp">0</span><span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_forall_method
  <span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_forall_cloref <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_foreach_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span>
  intrange_foreach_cloref&lt;<span class="keyword">&gt;</span> <span class="keyword">(</span><span class="dynexp">0</span><span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_foreach_method
  <span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_foreach_cloref <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">res</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_foldleft_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> ini<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span>
  intrange_foldleft_cloref&lt;<span class="staexp">res</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="dynexp">0</span><span class="keyword">,</span> n<span class="keyword">,</span> ini<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">res</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_foldleft_method
  <span class="keyword">(</span>n<span class="keyword">,</span> tres<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">lam</span><span class="keyword">(</span>ini<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_foldleft_cloref <span class="keyword">(</span>n<span class="keyword">,</span> ini<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
intrange_forall_cloref
  <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
loop
<span class="keyword">(</span>
  l<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun1</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">bool</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">if</span> l <span class="keyword">&lt;</span> r
  <span class="keyword">then</span> <span class="keyword">(</span>
    <span class="keyword">if</span> f<span class="keyword">(</span>l<span class="keyword">)</span> <span class="keyword">then</span> loop<span class="keyword">(</span>l+<span class="dynexp">1</span><span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">else</span> false
  <span class="keyword">)</span> <span class="keyword">else</span> true
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [loop] *)</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [intrange_forall_cloref]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
intrange_forall_method
  <span class="keyword">(</span> <span class="keyword">@(</span>l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> intrange_forall_cloref <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
intrange_foreach_cloref
  <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
loop
<span class="keyword">(</span>
  l<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun1</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">if</span> l <span class="keyword">&lt;</span> r
  <span class="keyword">then</span> <span class="keyword">let</span> <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f<span class="keyword">(</span>l<span class="keyword">)</span></span> <span class="keyword">in</span> loop<span class="keyword">(</span>l+<span class="dynexp">1</span><span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [loop] *)</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [intrange_foreach_cloref]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
intrange_foreach_method
  <span class="keyword">(</span> <span class="keyword">@(</span>l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> intrange_foreach_cloref <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">res</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
intrange_foldleft_cloref
  <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> ini<span class="keyword">,</span> fopr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
loop
<span class="keyword">(</span>
  l<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">,</span> ini<span class="keyword">:</span> <span class="staexp">res</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span><span class="keyword">(</span><span class="staexp">res</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">res</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">res</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">if</span> l <span class="keyword">&lt;</span> r <span class="keyword">then</span> loop <span class="keyword">(</span>l+<span class="dynexp">1</span><span class="keyword">,</span> r<span class="keyword">,</span> f<span class="keyword">(</span>ini<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">else</span> ini
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [loop] *)</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> ini<span class="keyword">,</span> fopr<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [intrange_foldleft_cloref]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">res</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
intrange_foldleft_method
  <span class="keyword">(</span> <span class="keyword">@(</span>l<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">,</span> tres <span class="keyword">)</span> <span class="keyword">=</span>
<span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">lam</span><span class="keyword">(</span>ini<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=&gt;</span>
  intrange_foldleft_cloref&lt;<span class="staexp">res</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">,</span> ini<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [intrange_foldleft_method] *)</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_streamGte<span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=</span>
<span class="keyword">(</span>
<span class="keyword">fix</span>
aux
<span class="keyword">(</span>
  n<span class="keyword">:</span><span class="staexp">int</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">stream</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="dynexp"><span class="keyword">$delay</span><span class="keyword">(</span>stream_cons<span class="keyword">(</span>n<span class="keyword">,</span> aux<span class="keyword">(</span>n+1<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">)</span> <span class="keyword">(</span>n<span class="keyword">)</span></span> <span class="comment">// end of [int_streamGte]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int_streamGte_vt<span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=</span>
<span class="keyword">(</span>
<span class="keyword">fix</span>
aux
<span class="keyword">(</span>
  n<span class="keyword">:</span><span class="staexp">int</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">stream_vt</span><span class="keyword">(</span><span class="staexp">int</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="dynexp"><span class="keyword">$ldelay</span><span class="keyword">(</span>stream_vt_cons<span class="keyword">(</span>n<span class="keyword">,</span> aux<span class="keyword">(</span>n+1<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">)</span> <span class="keyword">(</span>n<span class="keyword">)</span></span> <span class="comment">// end of [int_streamGte_vt]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_list0_map_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> list0_tabulate&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_list0_map_method
  <span class="keyword">(</span>n<span class="keyword">,</span> tres<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_list0_map_cloref&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_array0_map_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> fopr<span class="keyword">)</span> <span class="keyword">=</span>
<span class="keyword">(</span>
array0_tabulate&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
  <span class="keyword">(</span>i2sz<span class="keyword">(</span>n<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">lam</span><span class="keyword">(</span>i<span class="keyword">)</span> <span class="keyword">=&gt;</span> fopr<span class="keyword">(</span>sz2i<span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_array0_map_method
  <span class="keyword">(</span>n<span class="keyword">,</span> tres<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_array0_map_cloref&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_stream_map_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> auxmain<span class="keyword">(</span><span class="dynexp">0</span><span class="keyword">)</span> <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
auxmain
<span class="keyword">(</span>
  i<span class="keyword">:</span> <span class="staexp">Nat</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">stream</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="dynexp"><span class="keyword">$delay</span>
<span class="keyword">(</span>
<span class="keyword">if</span>
<span class="keyword">(</span>i <span class="keyword">&lt;</span> n<span class="keyword">)</span>
<span class="keyword">then</span> stream_cons<span class="keyword">(</span>f<span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">,</span> auxmain<span class="keyword">(</span>i+1<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> stream_nil<span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">)</span></span></span> <span class="comment">(* end of [auxmain] *)</span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [int_stream_map_cloref] *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_stream_map_method
  <span class="keyword">(</span>n<span class="keyword">,</span> tres<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_stream_map_cloref&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_stream_vt_map_cloref
  <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> auxmain<span class="keyword">(</span><span class="dynexp">0</span><span class="keyword">)</span> <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span>
auxmain
<span class="keyword">(</span>
  i<span class="keyword">:</span> <span class="staexp">Nat</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">stream_vt</span><span class="keyword">(</span><span class="staexp">a</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="dynexp"><span class="keyword">$ldelay</span>
<span class="keyword">(</span>
<span class="keyword">if</span>
<span class="keyword">(</span>i <span class="keyword">&lt;</span> n<span class="keyword">)</span>
<span class="keyword">then</span> stream_vt_cons<span class="keyword">(</span>f<span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">,</span> auxmain<span class="keyword">(</span>i+1<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> stream_vt_nil<span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> stream_vt_con<span class="keyword">(</span>a<span class="keyword">)</span></span></span> <span class="comment">// [auxmain]</span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [int_stream_vt_map_cloref] *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
int_stream_vt_map_method
  <span class="keyword">(</span>n<span class="keyword">,</span> tres<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span><span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> int_stream_vt_map_cloref&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
int2_foreach_cloref
  <span class="keyword">(</span>n1<span class="keyword">,</span> n2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span>
  intrange2_foreach_cloref&lt;<span class="keyword">&gt;</span> <span class="keyword">(</span><span class="dynexp">0</span><span class="keyword">,</span> n1<span class="keyword">,</span> <span class="dynexp">0</span><span class="keyword">,</span> n2<span class="keyword">,</span> f<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
intrange2_foreach_cloref
  <span class="keyword">(</span>l1<span class="keyword">,</span> r1<span class="keyword">,</span> l2<span class="keyword">,</span> r2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fnx</span>
loop1
<span class="keyword">(</span>
  m1<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r1<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">,</span> l2<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r2<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">if</span>
m1 <span class="keyword">&lt;</span> r1
<span class="keyword">then</span> loop2<span class="keyword">(</span>m1<span class="keyword">,</span> r1<span class="keyword">,</span> l2<span class="keyword">,</span> l2<span class="keyword">,</span> r2<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">)</span> <span class="comment">(* end of [loop1] *)</span>
<span class="comment">//</span>
<span class="keyword">and</span>
loop2
<span class="keyword">(</span>
  m1<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r1<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">,</span> l2<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> m2<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> r2<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">cfun2</span> <span class="keyword">(</span><span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">int</span><span class="keyword">,</span> <span class="staexp">void</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">if</span>
m2 <span class="keyword">&lt;</span> r2
<span class="keyword">then</span> <span class="keyword">(</span>
<span class="comment">//</span>
f<span class="keyword">(</span>m1<span class="keyword">,</span> m2<span class="keyword">)</span><span class="keyword">;</span>
loop2<span class="keyword">(</span>m1<span class="keyword">,</span> r1<span class="keyword">,</span> l2<span class="keyword">,</span> m2+<span class="dynexp">1</span><span class="keyword">,</span> r2<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">)</span> <span class="comment">(* end of [then] *)</span>
<span class="keyword">else</span> loop1<span class="keyword">(</span>m1+<span class="dynexp">1</span><span class="keyword">,</span> r1<span class="keyword">,</span> l2<span class="keyword">,</span> r2<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [loop2] *)</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  loop1 <span class="keyword">(</span>l1<span class="keyword">,</span> r1<span class="keyword">,</span> l2<span class="keyword">,</span> r2<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [intrange2_foreach_cloref]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [intrange.dats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: August, 2013 *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX-2012-12:</span>
<span class="comment">// the map implementation is based on AVL trees</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="keyword">staload</span> FM <span class="keyword">=</span>
"libats/SATS/funmap_avltree.sats"
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/list0.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/funmap.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="staexp"><span class="keyword">assume</span>
map_type<span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>map <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
compare_key_key <span class="keyword">=</span> gcompare_val_val&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
$FM<span class="keyword">.</span>compare_key_key <span class="keyword">=</span> compare_key_key&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
funmap_nil<span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>funmap_nil&lt;<span class="keyword">&gt;</span><span class="keyword">(</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
funmap_make_nil<span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>funmap_make_nil&lt;<span class="keyword">&gt;</span><span class="keyword">(</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
funmap_is_nil<span class="keyword">(</span>map<span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>funmap_is_nil&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
funmap_isnot_nil<span class="keyword">(</span>map<span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>funmap_isnot_nil&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_size
  <span class="keyword">(</span>map<span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>funmap_size&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_search
  <span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span>
  $FM<span class="keyword">.</span>funmap_search_opt&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_insert
  <span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span>
  $FM<span class="keyword">.</span>funmap_insert_opt&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">,</span> x<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_takeout
  <span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span>
  $FM<span class="keyword">.</span>funmap_takeout_opt&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_remove
  <span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>funmap_remove&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
fprint_funmap
  <span class="keyword">(</span>out<span class="keyword">,</span> map<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FM<span class="keyword">.</span>fprint_funmap$sep&lt;<span class="keyword">&gt;</span> <span class="keyword">=</span> fprint_funmap$sep&lt;<span class="keyword">&gt;</span></span>
<span class="dynexp"><span class="keyword">implement</span>
$FM<span class="keyword">.</span>fprint_funmap$mapto&lt;<span class="keyword">&gt;</span> <span class="keyword">=</span> fprint_funmap$mapto&lt;<span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $FM<span class="keyword">.</span>fprint_funmap&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>out<span class="keyword">,</span> map<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">in</span>
  <span class="comment">// nothing</span>
<span class="keyword">end</span></span></span> <span class="comment">// end of [fprint_funmap]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
fprint_funmap$sep<span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint<span class="keyword">(</span>out<span class="keyword">,</span> <span class="dynstr">"; "</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
fprint_funmap$mapto<span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint<span class="keyword">(</span>out<span class="keyword">,</span> <span class="dynstr">"-&gt;"</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_foreach_cloref
  <span class="keyword">(</span>map<span class="keyword">,</span> fwork<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span><span class="comment">(*tmp*)</span>
$FM<span class="keyword">.</span>funmap_foreach$fwork&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;&lt;</span><span class="staexp">env</span><span class="keyword">&gt;</span>
  <span class="keyword">(</span>k<span class="keyword">,</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> fwork<span class="keyword">(</span>k<span class="keyword">,</span> x<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span>
$FM<span class="keyword">.</span>funmap_foreach_env&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;&lt;</span><span class="staexp">void</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">,</span> env<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [funmap_foreach_cloref] *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_listize
  <span class="keyword">(</span>map<span class="keyword">)</span> <span class="keyword">=</span>
<span class="keyword">(</span>
<span class="keyword">$effmask_wrt</span>
<span class="keyword">(</span>
list0_of_list_vt
  <span class="keyword">(</span>$FM<span class="keyword">.</span>funmap_listize&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [funmap_listize] *)</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_streamize
  <span class="keyword">(</span>map<span class="keyword">)</span> <span class="keyword">=</span>
<span class="keyword">(</span>
<span class="keyword">$effmask_wrt</span>
  <span class="keyword">(</span>$FM<span class="keyword">.</span>funmap_streamize&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>map<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span></span> <span class="comment">(* end of [funmap_streamize] *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
funmap_make_module
  <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$rec</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynlab">nil</span> <span class="keyword">=</span> funmap_nil<span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span>
<span class="keyword">,</span>
<span class="dynlab">size</span> <span class="keyword">=</span> funmap_size&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">is_nil</span> <span class="keyword">=</span> funmap_is_nil<span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span>
<span class="keyword">,</span>
<span class="dynlab">isnot_nil</span> <span class="keyword">=</span> funmap_isnot_nil<span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span>
<span class="keyword">,</span>
<span class="dynlab">search</span> <span class="keyword">=</span> funmap_search&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">insert</span> <span class="keyword">=</span> funmap_insert&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">remove</span> <span class="keyword">=</span> funmap_remove&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">takeout</span> <span class="keyword">=</span> funmap_takeout&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">listize</span> <span class="keyword">=</span> funmap_listize&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">streamiize</span> <span class="keyword">=</span> funmap_streamize&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [funmap_make_module] *)</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [funmap.dats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: December, 2012 *)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX-2012-12: the set implementation is based on AVL trees</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="keyword">staload</span>
UN <span class="keyword">=</span> "prelude/SATS/unsafe.sats"
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="keyword">staload</span>
FS <span class="keyword">=</span>
"libats/SATS/funset_avltree.sats"
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/list0.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/funset.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
compare_elt_elt <span class="keyword">=</span> gcompare_val_val&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
$FS<span class="keyword">.</span>compare_elt_elt <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="staexp"><span class="keyword">assume</span> set_type <span class="keyword">(</span>a<span class="keyword">:</span>t0p<span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>set <span class="keyword">(</span>a<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
funset_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_nil <span class="keyword">(</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
funset_make_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_make_nil <span class="keyword">(</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
funset_sing <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_sing&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>x<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
funset_make_sing <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_make_sing&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>x<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
funset_make_list
  <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> xs <span class="keyword">=</span> g1ofg0_list<span class="keyword">(</span>xs<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_make_list&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_make_list]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
fprint_funset$sep
  <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span>
  fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="dynstr">", "</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
fprint_funset
  <span class="keyword">(</span>out<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>fprint_funset$sep&lt;<span class="keyword">&gt;</span>
  <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint_funset$sep&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>out<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>fprint_funset&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>out<span class="keyword">,</span> xs<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [fprint_funset]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
funset_is_nil
  <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_is_nil&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
funset_isnot_nil
  <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_isnot_nil&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_size<span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_size&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_is_member
  <span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_is_member&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_is_member]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_isnot_member
  <span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">~</span>funset_is_member&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_insert
  <span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_insert&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_insert]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_remove
  <span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_remove&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">,</span> x0<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_remove]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_getmax_opt <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_getmax_opt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_getmin_opt <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_getmin_opt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_takeoutmax_opt <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_takeoutmax_opt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_takeoutmin_opt <span class="keyword">=</span> $FS<span class="keyword">.</span>funset_takeoutmin_opt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_union
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_union&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_union]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_intersect
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_intersect&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_intersect]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_differ
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_differ&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_differ]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_symdiff
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_symdiff&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_symdiff]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_equal
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_equal&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_equal]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_compare
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_compare&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_compare]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_is_subset
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_is_subset&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_is_subset]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_is_supset
  <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> funset_is_subset&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs2<span class="keyword">,</span> xs1<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_foreach<span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  funset_foreach_env&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">void</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_foreach]</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">env</span><span class="keyword">}</span>
funset_foreach_env<span class="keyword">(</span>xs<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>funset_foreach$fwork&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">env</span><span class="keyword">&gt;</span>
  <span class="keyword">(</span>x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> funset_foreach$fwork&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">env</span><span class="keyword">&gt;</span><span class="keyword">(</span>x<span class="keyword">,</span> env<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_foreach_env&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">env</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_foreach_env]</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_foreach_cloref
  <span class="keyword">(</span>xs<span class="keyword">,</span> fwork<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span><span class="comment">(*tmp*)</span>
$FS<span class="keyword">.</span>funset_foreach$fwork&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">env</span><span class="keyword">&gt;</span><span class="keyword">(</span>x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> fwork<span class="keyword">(</span>x<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_foreach_env&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">void</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_foreach_cloref]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_tabulate_cloref
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span><span class="keyword">(</span>n<span class="keyword">,</span> fopr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$FS<span class="keyword">.</span>funset_tabulate$fopr&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>i<span class="keyword">)</span> <span class="keyword">=</span> fopr<span class="keyword">(</span>$UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>natLt<span class="keyword">(</span>n<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $FS<span class="keyword">.</span>funset_tabulate&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>n<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [funset_tabulate]</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_listize
  <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
<span class="comment">//</span>
<span class="keyword">$effmask_wrt</span>
<span class="keyword">(</span>
  list0_of_list_vt<span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span><span class="keyword">(</span>$FS<span class="keyword">.</span>funset_listize&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="comment">(* $effmask_wrt *)</span>
<span class="comment">//</span>
<span class="keyword">)</span></span> <span class="comment">(* funset_listize *)</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_streamize
  <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_wrt</span><span class="keyword">(</span>$FS<span class="keyword">.</span>funset_streamize&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
funset_make_module
  <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$rec</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynlab">nil</span> <span class="keyword">=</span> funset_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span>
<span class="keyword">,</span>
<span class="dynlab">sing</span> <span class="keyword">=</span> funset_sing&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">make_list</span> <span class="keyword">=</span> funset_make_list&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">size</span> <span class="keyword">=</span> funset_size&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">is_nil</span> <span class="keyword">=</span> funset_is_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span>
<span class="keyword">,</span>
<span class="dynlab">isnot_nil</span> <span class="keyword">=</span> funset_isnot_nil<span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span>
<span class="keyword">,</span>
<span class="dynlab">insert</span><span class="keyword">=</span> funset_insert&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">remove</span><span class="keyword">=</span> funset_remove&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">union</span><span class="keyword">=</span> funset_union&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">intersect</span><span class="keyword">=</span> funset_intersect&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">listize</span> <span class="keyword">=</span> funset_listize&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="keyword">,</span>
<span class="dynlab">streamiize</span> <span class="keyword">=</span> funset_streamize&lt;<span class="staexp">a</span><span class="keyword">&gt;</span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [funset_make_module] *)</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [funset.dats] *)</span>
</pre>
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: gmhwxiATgmailDOTcom *)</span>
<span class="comment">(* Start time: August, 2013 *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span>
UN <span class="keyword">=</span> "prelude/SATS/unsafe.sats"

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="keyword">staload</span> HT <span class="keyword">=</span>
"libats/SATS/hashtbl_chain.sats"
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/basis.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/ML/SATS/list0.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> "libats/SATS/hashfun.sats"
<span class="keyword">staload</span> "libats/ML/SATS/hashtblref.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
implement
{key}(*tmp*)
hash_key = ghash_val&lt;key&gt;
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
equal_key_key <span class="keyword">=</span> gequal_val_val&lt;<span class="staexp">key</span><span class="keyword">&gt;</span></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
hash_key&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>key<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> key <span class="keyword">=</span> $UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>uint32<span class="keyword">}</span></span><span class="keyword">(</span>key<span class="keyword">)</span></span>
<span class="keyword">in</span>
  $UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>ulint<span class="keyword">}</span></span><span class="keyword">(</span>inthash_jenkins&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>key<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [hash_key&lt;int&gt;]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
hash_key&lt;<span class="staexp">uint</span><span class="keyword">&gt;</span> <span class="keyword">(</span>key<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> key <span class="keyword">=</span> $UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>uint32<span class="keyword">}</span></span><span class="keyword">(</span>key<span class="keyword">)</span></span>
<span class="keyword">in</span>
  $UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>ulint<span class="keyword">}</span></span><span class="keyword">(</span>inthash_jenkins&lt;<span class="keyword">&gt;</span><span class="keyword">(</span>key<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [hash_key&lt;uint&gt;]</span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="comment">// HX: 31 and 37 are top choices</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
hash_key&lt;<span class="staexp">string</span><span class="keyword">&gt;</span> <span class="keyword">(</span>key<span class="keyword">)</span> <span class="keyword">=</span>
  string_hash_multiplier <span class="keyword">(</span><span class="dynexp">31UL</span><span class="keyword">,</span> <span class="dynexp">31415926536UL</span><span class="keyword">,</span> key<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
$HT<span class="keyword">.</span>hash_key <span class="keyword">=</span> hash_key&lt;<span class="staexp">key</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
$HT<span class="keyword">.</span>equal_key_key <span class="keyword">=</span> equal_key_key&lt;<span class="staexp">key</span><span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="keyword">extern</span>
<span class="dynexp"><span class="keyword">castfn</span>
hashtbl_encode
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
<span class="keyword">(</span>
  <span class="staexp">$HT<span class="keyword">.</span>hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">extern</span>
<span class="dynexp"><span class="keyword">castfn</span>
hashtbl_decode
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="staexp">hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">INV</span><span class="keyword">(</span><span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">$HT<span class="keyword">.</span>hashtbl</span><span class="keyword">(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">#define</span> htencode hashtbl_encode</span>
<span class="neuexp"><span class="keyword">#define</span> htdecode hashtbl_decode</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_make_nil <span class="keyword">(</span>cap<span class="keyword">)</span> <span class="keyword">=</span>
  htencode<span class="keyword">(</span>$HT<span class="keyword">.</span>hashtbl_make_nil&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>cap<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
hashtbl_get_size
  <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> nitm <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> nitm <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_get_size <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_get_size] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
hashtbl_get_capacity
  <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> cap <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> cap <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_get_capacity <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_get_capacity] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_search
  <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> opt <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> opt <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_search_opt <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_search] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_search_ref
  <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> cptr <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> cptr <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_search_ref <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_search_ref] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_insert
  <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> opt <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> opt <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_insert_opt&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">,</span> x<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* hashtbl_insert *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_insert_any
  <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_insert_any&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">,</span> x<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* hashtbl_insert_any *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_takeout
  <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> opt <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> opt <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_takeout_opt <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_takeout] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_remove
  <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> ans <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> ans <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_remove <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_remove] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_takeout_all
  <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> kxs <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> kxs <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_takeout_all <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> kxs <span class="keyword">=</span> list0_of_list_vt<span class="staexp"><span class="keyword">{</span><span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>kxs<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_takeout_all] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
fprint_hashtbl
  <span class="keyword">(</span>out<span class="keyword">,</span> tbl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
$HT<span class="keyword">.</span>fprint_hashtbl$sep&lt;<span class="keyword">&gt;</span> <span class="keyword">=</span> fprint_hashtbl$sep&lt;<span class="keyword">&gt;</span></span>
<span class="dynexp"><span class="keyword">implement</span>
$HT<span class="keyword">.</span>fprint_hashtbl$mapto&lt;<span class="keyword">&gt;</span> <span class="keyword">=</span> fprint_hashtbl$mapto&lt;<span class="keyword">&gt;</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $HT<span class="keyword">.</span>fprint_hashtbl <span class="keyword">(</span>out<span class="keyword">,</span> tbl<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">in</span>
  <span class="comment">// nothing</span>
<span class="keyword">end</span></span></span> <span class="comment">// end of [fprint_hashtbl]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
fprint_hashtbl$sep <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> <span class="dynstr">"; "</span><span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
fprint_hashtbl$mapto <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> <span class="dynstr">"-&gt;"</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
fprint_hashtbl_sep_mapto
  <span class="keyword">(</span>out<span class="keyword">,</span> tbl<span class="keyword">,</span> sep<span class="keyword">,</span> mapto<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
fprint_hashtbl$sep&lt;<span class="keyword">&gt;</span> <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> sep<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">implement</span>
fprint_hashtbl$mapto&lt;<span class="keyword">&gt;</span> <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> mapto<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  fprint_hashtbl&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span><span class="keyword">(</span>out<span class="keyword">,</span> tbl<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [fprint_hashtbl_sep_mapto]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_foreach_cloref
  <span class="keyword">(</span>tbl<span class="keyword">,</span> fwork<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">(</span><span class="staexp">env</span><span class="keyword">)</span><span class="comment">(*tmp*)</span>
$HT<span class="keyword">.</span>hashtbl_foreach$fwork&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;&lt;</span><span class="staexp">env</span><span class="keyword">&gt;</span> <span class="keyword">(</span>k<span class="keyword">,</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> fwork<span class="keyword">(</span>k<span class="keyword">,</span> x<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_foreach_env&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;&lt;</span><span class="staexp">void</span><span class="keyword">&gt;</span> <span class="keyword">(</span>tbl<span class="keyword">,</span> env<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_foreach_cloref] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm</span><span class="keyword">}</span>
hashtbl_listize1
  <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> kxs <span class="keyword">where</span>
<span class="keyword">{</span>
<span class="comment">//</span>
<span class="keyword">typedef</span> <span class="staexp">ki <span class="keyword">=</span> <span class="keyword">@(</span><span class="staexp">key</span><span class="keyword">,</span> <span class="staexp">itm</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> tbl <span class="keyword">=</span> htdecode <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> kxs <span class="keyword">=</span> $HT<span class="keyword">.</span>hashtbl_listize1 <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void <span class="keyword">(</span>tbl<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> kxs <span class="keyword">=</span> list0_of_list_vt<span class="staexp"><span class="keyword">{</span><span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>kxs<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">}</span></span> <span class="comment">(* end of [hashtbl_listize1] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [hashtblref.dats] *)</span>
</pre>
<!--php-->

</body>
</html>
