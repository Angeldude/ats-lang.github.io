<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .patsyntax {color:#808080;background-color:#E0E0E0;}
    .patsyntax span.keyword {color:#000000;font-weight:bold;}
    .patsyntax span.comment {color:#787878;font-style:italic;}
    .patsyntax span.extcode {color:#A52A2A;}
    .patsyntax span.neuexp  {color:#800080;}
    .patsyntax span.staexp  {color:#0000F0;}
    .patsyntax span.prfexp  {color:#603030;}
    .patsyntax span.dynexp  {color:#F00000;}
    .patsyntax span.stalab  {color:#0000F0;font-style:italic}
    .patsyntax span.dynlab  {color:#F00000;font-style:italic}
    .patsyntax span.dynstr  {color:#008000;font-style:normal}
    .patsyntax span.stacstdec  {text-decoration:none;}
    .patsyntax span.stacstuse  {color:#0000CF;text-decoration:underline;}
    .patsyntax span.dyncstdec  {text-decoration:none;}
    .patsyntax span.dyncstuse  {color:#B80000;text-decoration:underline;}
    .patsyntax span.dyncst_implement  {color:#B80000;text-decoration:underline;}
  </style>
</head>
<body class="patsyntax">
<pre class="patsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Postiats - Unleashing the Potential of Types!
** Copyright (C) 2010-2013 Hongwei Xi, ATS Trustful Software, Inc.
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
**
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
**
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** Source:
** $PATSHOME/prelude/DATS/CODEGEN/strptr.atxt
** Time of generation: Sat Jun 27 21:39:24 2015
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Author: Hongwei Xi *)</span>
<span class="comment">(* Authoremail: hwxi AT cs DOT bu DOT edu *)</span>
<span class="comment">(* Start time: April, 2012 *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">#define</span> ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynloading at run-time</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> UN <span class="keyword">=</span> "prelude/SATS/unsafe.sats"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> _<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/integer.dats"

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">#define</span> CNUL '\000'</span>
<span class="neuexp"><span class="keyword">#define</span> nullp the_null_ptr</span>

<span class="comment">(* ****** ****** *)</span>

<span class="dynexp"><span class="keyword">overload</span> + <span class="keyword">with</span> add_ptr_bsz</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr_is_null <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>strptr2ptr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> nullp<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr_isnot_null <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>strptr2ptr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">&gt;</span> nullp<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr_is_empty <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> p <span class="keyword">=</span> strptr2ptr <span class="keyword">(</span>str<span class="keyword">)</span></span> <span class="keyword">in</span> $UN<span class="keyword">.</span>ptr1_get&lt;<span class="staexp">char</span><span class="keyword">&gt;</span><span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> CNUL
<span class="keyword">end</span></span> <span class="comment">// end of [strptr_is_empty]</span>
<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr_isnot_empty <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> p <span class="keyword">=</span> strptr2ptr <span class="keyword">(</span>str<span class="keyword">)</span></span> <span class="keyword">in</span> $UN<span class="keyword">.</span>ptr1_get&lt;<span class="staexp">char</span><span class="keyword">&gt;</span><span class="keyword">(</span>p<span class="keyword">)</span> != CNUL
<span class="keyword">end</span></span> <span class="comment">// end of [strptr_isnot_empty]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strnptr_get_at_size <span class="keyword">(</span>str<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span>
  $UN<span class="keyword">.</span>ptr0_get&lt;<span class="staexp">charNZ</span><span class="keyword">&gt;</span><span class="keyword">(</span>strnptr2ptr<span class="keyword">(</span>str<span class="keyword">)</span> + i<span class="keyword">)</span></span>
<span class="comment">// end of [strnptr_get_at_size]</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">tk</span><span class="keyword">}</span>
strnptr_get_at_gint <span class="keyword">(</span>str<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span>
  strnptr_get_at_size <span class="keyword">(</span>str<span class="keyword">,</span> g1int2uint <span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">// end of [strnptr_get_at_gint]</span>
<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">tk</span><span class="keyword">}</span>
strnptr_get_at_guint <span class="keyword">(</span>str<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span>
  strnptr_get_at_size <span class="keyword">(</span>str<span class="keyword">,</span> g1uint2uint <span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">// end of [strnptr_get_at_guint]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strnptr_set_at_size <span class="keyword">(</span>str<span class="keyword">,</span> i<span class="keyword">,</span> c<span class="keyword">)</span> <span class="keyword">=</span>
  $UN<span class="keyword">.</span>ptr0_set&lt;<span class="staexp">charNZ</span><span class="keyword">&gt;</span><span class="keyword">(</span>strnptr2ptr<span class="keyword">(</span>str<span class="keyword">)</span> + i<span class="keyword">,</span> c<span class="keyword">)</span></span>
<span class="comment">// end of [strnptr_set_at_size]</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">tk</span><span class="keyword">}</span>
strnptr_set_at_gint <span class="keyword">(</span>str<span class="keyword">,</span> i<span class="keyword">,</span> c<span class="keyword">)</span> <span class="keyword">=</span>
  strnptr_set_at_size <span class="keyword">(</span>str<span class="keyword">,</span> g1int2uint <span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">,</span> c<span class="keyword">)</span></span>
<span class="comment">// end of [strnptr_set_at_gint]</span>
<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">tk</span><span class="keyword">}</span>
strnptr_set_at_guint <span class="keyword">(</span>str<span class="keyword">,</span> i<span class="keyword">,</span> c<span class="keyword">)</span> <span class="keyword">=</span>
  strnptr_set_at_size <span class="keyword">(</span>str<span class="keyword">,</span> g1uint2uint <span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">,</span> c<span class="keyword">)</span></span>
<span class="comment">// end of [strnptr_set_at_guint]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
lt_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>compare_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">&lt;</span> <span class="dynexp">0</span><span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span>
lte_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>compare_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> &lt;= <span class="dynexp">0</span><span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span>
gt_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>compare_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">&gt;</span> <span class="dynexp">0</span><span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span>
gte_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>compare_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> &gt;= <span class="dynexp">0</span><span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span>
eq_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>compare_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="dynexp">0</span><span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span>
neq_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>compare_strptr_strptr <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> != <span class="dynexp">0</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
//
// HX: implemented in [strptr.cats]
//
implement
print_strptr (x) = fprint_strptr (stdout_ref, x)
implement
prerr_strptr (x) = fprint_strptr (stderr_ref, x)
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strnptr_is_null <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>strnptr2ptr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> nullp<span class="keyword">)</span></span>
<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strnptr_isnot_null <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>strnptr2ptr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">&gt;</span> nullp<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr_length<span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> isnot <span class="keyword">=</span> ptr_isnot_null<span class="keyword">(</span>strptr2ptr<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span> isnot
  <span class="keyword">then</span> g0u2i<span class="keyword">(</span>string_length<span class="keyword">(</span>$UN<span class="keyword">.</span>strptr2string<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">else</span> g0i2i<span class="keyword">(</span><span class="keyword">~</span><span class="dynexp">1</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strptr_length]</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strnptr_length<span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma_strnptr_param <span class="keyword">(</span>x<span class="keyword">)</span></span>
  <span class="dynexp"><span class="keyword">val</span> isnot <span class="keyword">=</span> ptr_isnot_null<span class="keyword">(</span>strnptr2ptr<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span> isnot
  <span class="keyword">then</span> g1u2i<span class="keyword">(</span>string_length<span class="keyword">(</span>$UN<span class="keyword">.</span>strnptr2string<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">else</span> g1i2i<span class="keyword">(</span><span class="keyword">~</span><span class="dynexp">1</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strnptr_length]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr0_copy<span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> isnot <span class="keyword">=</span> ptr_isnot_null<span class="keyword">(</span>strptr2ptr<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span> isnot
  <span class="keyword">then</span> string0_copy<span class="keyword">(</span>$UN<span class="keyword">.</span>strptr2string<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> strptr_null<span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strptr0_copy]</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr1_copy<span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> string0_copy<span class="keyword">(</span>$UN<span class="keyword">.</span>strptr2string<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strnptr_copy
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span><span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> x2 <span class="keyword">where</span>
<span class="keyword">{</span>
  <span class="dynexp"><span class="keyword">val</span> x <span class="keyword">=</span> strnptr2ptr<span class="keyword">(</span>x<span class="keyword">)</span></span>
  <span class="dynexp"><span class="keyword">val</span> x <span class="keyword">=</span> $UN<span class="keyword">.</span>castvwtp0<span class="staexp"><span class="keyword">{</span>Strptr0<span class="keyword">}</span></span><span class="keyword">(</span>x<span class="keyword">)</span></span>
  <span class="dynexp"><span class="keyword">val</span> x2 <span class="keyword">=</span> $UN<span class="keyword">.</span>castvwtp0<span class="staexp"><span class="keyword">{</span>strnptr<span class="keyword">(</span>n<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>strptr0_copy<span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> $UN<span class="keyword">.</span>cast2void<span class="keyword">(</span>x<span class="keyword">)</span></span>
<span class="keyword">}</span></span> <span class="comment">(* end of [strnptr_copy] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptr_append
  <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> isnot1 <span class="keyword">=</span> ptr_isnot_null <span class="keyword">(</span>strptr2ptr<span class="keyword">(</span>x1<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span> isnot1 <span class="keyword">then</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> isnot2 <span class="keyword">=</span> ptr_isnot_null <span class="keyword">(</span>strptr2ptr<span class="keyword">(</span>x2<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span>
isnot2
<span class="keyword">then</span>
  strnptr2strptr<span class="keyword">(</span>string1_append <span class="keyword">(</span>$UN<span class="keyword">.</span>strptr2string<span class="keyword">(</span>x1<span class="keyword">)</span><span class="keyword">,</span> $UN<span class="keyword">.</span>strptr2string<span class="keyword">(</span>x2<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">else</span>
  strptr1_copy <span class="keyword">(</span>x1<span class="keyword">)</span>
<span class="comment">// end of [if]</span>
<span class="comment">//</span>
<span class="keyword">end</span> <span class="keyword">else</span>
  strptr0_copy <span class="keyword">(</span>x2<span class="keyword">)</span>
<span class="comment">// end of [if]</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strptr_append]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptrlst_free <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span> loop
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">List_vt</span><span class="keyword">(</span><span class="staexp">Strptr0</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">case+</span> xs <span class="keyword">of</span>
<span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons
    <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>strptr_free <span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [loop]</span>
<span class="comment">//</span>
<span class="keyword">in</span>
  <span class="keyword">$effmask_all</span> <span class="keyword">(</span>loop <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strptrlst_free]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span>
strptrlst_concat <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma_list_vt_param <span class="keyword">(</span>xs<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span> loop
  <span class="staexp"><span class="keyword">{</span>n0<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">.&lt;</span><span class="staexp">n0</span><span class="keyword">&gt;.</span>
<span class="keyword">(</span>
  xs<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">list_vt</span><span class="keyword">(</span><span class="staexp">Strptr0</span><span class="keyword">,</span> <span class="staexp">n0</span><span class="keyword">)</span><span class="staexp">&gt;&gt;</span><span class="staexp">list_vt</span><span class="keyword">(</span><span class="staexp">Strptr1</span><span class="keyword">,</span> <span class="staexp">n1</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">wrt</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">#[</span>n1<span class="keyword">:</span>nat <span class="keyword">|</span> n1 &lt;= n0<span class="keyword">]</span></span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">case+</span> xs <span class="keyword">of</span>
<span class="keyword">|</span> <span class="keyword">@</span>list_vt_cons
    <span class="keyword">(</span>x<span class="keyword">,</span> xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="dynexp"><span class="keyword">val</span> isnot <span class="keyword">=</span> strptr_isnot_null <span class="keyword">(</span>x<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> isnot <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>xs1<span class="keyword">)</span></span>
      <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">fold@</span> <span class="keyword">(</span>xs<span class="keyword">)</span></span>
    <span class="dynexp"><span class="keyword">in</span>
      <span class="comment">// nothing</span>
    <span class="keyword">end</span></span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
        strptr_free_null <span class="keyword">(</span>x<span class="keyword">)</span></span>
      <span class="dynexp"><span class="keyword">val</span> xs1 <span class="keyword">=</span> xs1</span>
      <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">free@</span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span><span class="keyword">(</span>xs<span class="keyword">)</span></span>
      <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>xs := xs1<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      loop <span class="keyword">(</span>xs<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]</span>
  <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]</span>
<span class="keyword">|</span> <span class="keyword">@</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">fold@</span> <span class="keyword">(</span>xs<span class="keyword">)</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [loop]</span>
<span class="comment">//</span>
<span class="keyword">var</span> xs <span class="keyword">=</span> xs
<span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>xs<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">case+</span> xs <span class="keyword">of</span>
<span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> strptr_null <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> x
<span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="dynexp"><span class="keyword">val</span> res <span class="keyword">=</span>
      stringlst_concat <span class="keyword">(</span>$UN<span class="keyword">.</span>castvwtp1<span class="staexp"><span class="keyword">{</span>List<span class="keyword">(</span>string<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    loop <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="dynexp"><span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">.&lt;</span><span class="staexp">n</span><span class="keyword">&gt;.</span>
        <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list_vt</span> <span class="keyword">(</span><span class="staexp">Strptr1</span><span class="keyword">,</span> <span class="staexp">n</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">wrt</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
        <span class="keyword">case+</span> xs <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>strptr_free <span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span></span>
      <span class="comment">// end of [loop]</span>
    <span class="keyword">}</span></span> <span class="comment">// end of [where] // end of [val]</span>
  <span class="keyword">in</span>
    res
  <span class="keyword">end</span> <span class="comment">// end of [_]</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strptrlst_concat]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">env</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
strnptr_foreach$cont <span class="keyword">(</span>c<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> true</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
strnptr_foreach <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">in</span> strnptr_foreach_env&lt;<span class="staexp">void</span><span class="keyword">&gt;</span> <span class="keyword">(</span>str<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strnptr_foreach]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">env</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
strnptr_foreach_env
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="keyword">(</span>str<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span> loop
<span class="keyword">(</span>
  p<span class="keyword">:</span> <span class="staexp">ptr</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">env</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">ptr</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="neuexp"><span class="keyword">#define</span> NUL '\000'</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> c <span class="keyword">=</span> $UN<span class="keyword">.</span>ptr0_get&lt;<span class="staexp">Char</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span>
<span class="keyword">(</span>c != NUL<span class="keyword">)</span>
<span class="keyword">then</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">fpf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span>
    $UN<span class="keyword">.</span>ptr0_vtake<span class="staexp"><span class="keyword">{</span>charNZ<span class="keyword">}</span></span><span class="keyword">(</span>p<span class="keyword">)</span></span>
  <span class="dynexp"><span class="keyword">val</span> cont <span class="keyword">=</span>
    strnptr_foreach$cont&lt;<span class="staexp">env</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> env<span class="keyword">)</span></span>
  <span class="comment">// end of [val]</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> cont
    <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
      strnptr_foreach$fwork&lt;<span class="staexp">env</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> env<span class="keyword">)</span></span>
      <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> fpf <span class="keyword">(</span>pf<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      loop <span class="keyword">(</span>ptr_succ&lt;<span class="staexp">char</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p<span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [then]</span>
    <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> fpf <span class="keyword">(</span>pf<span class="keyword">)</span></span> <span class="keyword">in</span> <span class="keyword">(</span>p<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [else]    </span>
<span class="keyword">end</span> <span class="comment">// end of [then]</span>
<span class="keyword">else</span> <span class="keyword">(</span>p<span class="keyword">)</span> <span class="comment">// end of [else]</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [loop]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> p0 <span class="keyword">=</span> ptrcast<span class="keyword">(</span>str<span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>sizeLte<span class="keyword">(</span>n<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>loop <span class="keyword">(</span>p0<span class="keyword">,</span> env<span class="keyword">)</span> - p0<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strnptr_foreach_env]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">env</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
strnptr_rforeach$cont <span class="keyword">(</span>c<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> true</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp"><span class="keyword">}</span></span><span class="comment">(*tmp*)</span>
strnptr_rforeach <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">in</span> strnptr_rforeach_env&lt;<span class="staexp">void</span><span class="keyword">&gt;</span> <span class="keyword">(</span>str<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strnptr_rforeach]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="prfexp"><span class="keyword">implement</span>
<span class="keyword">{</span><span class="staexp">env</span><span class="keyword">}</span><span class="comment">(*tmp*)</span>
strnptr_rforeach_env
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="keyword">(</span>str<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">fun</span> loop
<span class="keyword">(</span>
  p0<span class="keyword">:</span> <span class="staexp">ptr</span><span class="keyword">,</span> p1<span class="keyword">:</span> <span class="staexp">ptr</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">&amp;</span><span class="staexp">env</span> <span class="staexp">&gt;&gt;</span> <span class="staexp">_</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">ptr</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
<span class="comment">//</span>
<span class="keyword">if</span>
<span class="keyword">(</span>p1 <span class="keyword">&gt;</span> p0<span class="keyword">)</span>
<span class="keyword">then</span> <span class="keyword">let</span>
  <span class="dynexp"><span class="keyword">val</span> p2 <span class="keyword">=</span> ptr_pred&lt;<span class="staexp">char</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p1<span class="keyword">)</span></span>
  <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">fpf</span> <span class="keyword">|</span> p2<span class="keyword">)</span> <span class="keyword">=</span>
    $UN<span class="keyword">.</span>ptr0_vtake<span class="staexp"><span class="keyword">{</span>charNZ<span class="keyword">}</span></span><span class="keyword">(</span>p2<span class="keyword">)</span></span>
  <span class="dynexp"><span class="keyword">val</span> cont <span class="keyword">=</span>
    strnptr_rforeach$cont&lt;<span class="staexp">env</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p2<span class="keyword">,</span> env<span class="keyword">)</span></span>
  <span class="comment">// end of [val]</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> cont
    <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="dynexp"><span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
      strnptr_rforeach$fwork&lt;<span class="staexp">env</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p2<span class="keyword">,</span> env<span class="keyword">)</span></span>
      <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> fpf <span class="keyword">(</span>pf<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      loop <span class="keyword">(</span>p0<span class="keyword">,</span> p2<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [then]</span>
    <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="prfexp"><span class="keyword">prval</span> <span class="keyword">(</span><span class="comment">(*void*)</span><span class="keyword">)</span> <span class="keyword">=</span> fpf <span class="keyword">(</span>pf<span class="keyword">)</span></span> <span class="keyword">in</span> <span class="keyword">(</span>p1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [else]    </span>
<span class="keyword">end</span> <span class="comment">// end of [then]</span>
<span class="keyword">else</span> <span class="keyword">(</span>p1<span class="keyword">)</span> <span class="comment">// end of [else]</span>
<span class="comment">//</span>
<span class="keyword">end</span></span> <span class="comment">// end of [loop]</span>
<span class="comment">//</span>
<span class="dynexp"><span class="keyword">val</span> p0 <span class="keyword">=</span> ptrcast<span class="keyword">(</span>str<span class="keyword">)</span></span>
<span class="dynexp"><span class="keyword">val</span> p1 <span class="keyword">=</span> ptr_add&lt;<span class="staexp">char</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p0<span class="keyword">,</span> length<span class="keyword">(</span>str<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">//</span>
<span class="keyword">in</span>
  $UN<span class="keyword">.</span>cast<span class="staexp"><span class="keyword">{</span>sizeLte<span class="keyword">(</span>n<span class="keyword">)</span><span class="keyword">}</span></span><span class="keyword">(</span>p1 - loop <span class="keyword">(</span>p0<span class="keyword">,</span> p1<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [strnptr_rforeach_env]</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [strptr.dats] *)</span>
</pre>
</body>
</html>
